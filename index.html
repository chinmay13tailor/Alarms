<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Table</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f0f0f0;
    }
    table {
      width: 100%;
      max-width: 600px;
      margin: auto;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border: 1px solid #ccc;
    }
    th {
      background: #ffcc00;
    }
  </style>
</head>
<body>

<h2 style="text-align:center">Customer Telemetry</h2>
<table id="customerTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Customer</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const jwt = new URLSearchParams(window.location.search).get("token");
  const deviceId = "Skp2xAAE3OqhqKHTMhLY";
  const apiBase = "https://thingsboard.cloud/api";
  const tableBody = document.querySelector("#customerTable tbody");

  async function loadCustomers() {
    try {
      const url = `${apiBase}/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=Customer`;
      const res = await fetch(url, {
        headers: { "X-Authorization": `Bearer ${jwt}` }
      });

      if (!res.ok) throw new Error("Failed to fetch");

      const data = await res.json();
      const entries = data.Customer || [];

      entries.forEach((entry, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${entry.value}</td>
          <td>${new Date(entry.ts).toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}</td>
        `;
        tableBody.appendChild(row);
      });

      if (entries.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="3">No Customer telemetry found.</td></tr>`;
      }

    } catch (err) {
      console.error("Error loading customer data:", err);
      tableBody.innerHTML = `<tr><td colspan="3">Failed to load data.</td></tr>`;
    }
  }

  if (!jwt) {
    alert("Missing token. Please add ?token=YOUR_JWT_TOKEN in the URL.");
  } else {
    loadCustomers();
  }
</script>

</body>
</html>
