<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alarm Viewer</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      padding: 2rem;
      margin: 0;
      color: #333;
    }

    h2 {
      text-align: center;
      margin-bottom: 2rem;
    }

    .filter-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
      background: white;
      padding: 1rem 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      max-width: 1200px;
      margin: auto;
    }

    label {
      font-weight: 500;
      display: block;
    }

    input, select, button {
      padding: 0.5rem 0.8rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-width: 180px;
    }

    button {
      background: orange;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    table {
      margin: 2rem auto;
      width: 80%;
      border-collapse: collapse;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      background: white;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background: #ffa500;
      color: white;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <h2>Alarm Table Viewer</h2>

  <div class="filter-row">
    <div>
      <label for="startDate">Start Time</label>
      <input type="datetime-local" id="startDate" step="1">
    </div>

    <div>
      <label for="endDate">End Time</label>
      <input type="datetime-local" id="endDate" step="1">
    </div>

    <div>
      <label for="customerSelect">Customer</label>
      <select id="customerSelect"><option value="">-- Select --</option></select>
    </div>

    <div>
      <label for="machineSelect">Machine</label>
      <select id="machineSelect"><option value="">-- Select --</option></select>
    </div>

    <div>
      <button onclick="loadAlarms()">Generate</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Alarm Code</th>
        <th>Alarm Description</th>
        <th>Alarm Level</th>
      </tr>
    </thead>
    <tbody id="alarmTable">
      <tr><td colspan="3">No data</td></tr>
    </tbody>
  </table>

  <p class="error" id="errorMsg"></p>

  <script>
    const jwt = new URLSearchParams(window.location.search).get("token");
    const masterDeviceId = "03990870-4108-11f0-9143-ed31251bb06c";
    const baseUrl = "https://thingsboard.cloud/api";
    let telemetryData = [];

    const startInput = document.getElementById("startDate");
    const endInput = document.getElementById("endDate");
    const customerSelect = document.getElementById("customerSelect");
    const machineSelect = document.getElementById("machineSelect");
    const alarmTable = document.getElementById("alarmTable");
    const errorMsg = document.getElementById("errorMsg");

    async function fetchTelemetryData(startTs, endTs) {
      const url = `${baseUrl}/plugins/telemetry/DEVICE/${masterDeviceId}/values/timeseries?keys=Customer,Machine,Machine_Token&startTs=${startTs}&endTs=${endTs}&limit=1000&agg=NONE`;
      const res = await fetch(url, {
        headers: { "X-Authorization": `Bearer ${jwt}` }
      });
      if (!res.ok) throw new Error("Failed to fetch master device telemetry");
      return await res.json();
    }

    async function populateFilters() {
      if (!startInput.value || !endInput.value) return;

      const startTs = new Date(startInput.value).getTime();
      const endTs = new Date(endInput.value).getTime();

      try {
        const data = await fetchTelemetryData(startTs, endTs);
        const customers = data.Customer || [];
        const machines = data.Machine || [];
        const tokens = data.Machine_Token || [];

        telemetryData = customers.map((c, i) => ({
          customer: c.value,
          machine: machines[i]?.value,
          token: tokens[i]?.value
        }));

        const uniqueCustomers = [...new Set(telemetryData.map(d => d.customer))];
        customerSelect.innerHTML = '<option value="">-- Select --</option>';
        uniqueCustomers.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          customerSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "Error fetching filter data.";
      }
    }

    function updateMachineDropdown() {
      const selectedCustomer = customerSelect.value;
      const machines = telemetryData
        .filter(d => d.customer === selectedCustomer)
        .map(d => d.machine);

      const uniqueMachines = [...new Set(machines)];
      machineSelect.innerHTML = '<option value="">-- Select --</option>';
      uniqueMachines.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        machineSelect.appendChild(opt);
      });
    }

    async function loadAlarms() {
      alarmTable.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
      errorMsg.textContent = "";

      const customer = customerSelect.value;
      const machine = machineSelect.value;
      const start = startInput.value;
      const end = endInput.value;

      if (!customer || !machine || !start || !end) {
        errorMsg.textContent = "Please fill all filters.";
        alarmTable.innerHTML = '<tr><td colspan="3">No data</td></tr>';
        return;
      }

      const match = telemetryData.find(d => d.customer === customer && d.machine === machine);
      if (!match || !match.token) {
        errorMsg.textContent = "Matching machine token not found.";
        alarmTable.innerHTML = '<tr><td colspan="3">No data</td></tr>';
        return;
      }

      const startTs = new Date(start).getTime();
      const endTs = new Date(end).getTime();
      const deviceId = match.token;

      try {
        const url = `${baseUrl}/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=Alarm_Code,Alarm_Description,Alarm_Level&startTs=${startTs}&endTs=${endTs}&limit=1000&agg=NONE`;
        const res = await fetch(url, {
          headers: { "X-Authorization": `Bearer ${jwt}` }
        });
        const json = await res.json();

        const codes = json.Alarm_Code || [];
        const descs = json.Alarm_Description || [];
        const levels = json.Alarm_Level || [];

        if (codes.length === 0) {
          alarmTable.innerHTML = '<tr><td colspan="3">No alarms found.</td></tr>';
          return;
        }

        alarmTable.innerHTML = "";
        codes.forEach((c, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${c.value || "-"}</td>
            <td>${descs[i]?.value || "-"}</td>
            <td>${levels[i]?.value || "-"}</td>
          `;
          alarmTable.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        errorMsg.textContent = "Failed to load alarms.";
        alarmTable.innerHTML = '<tr><td colspan="3">Error</td></tr>';
      }
    }

    startInput.addEventListener("change", populateFilters);
    endInput.addEventListener("change", populateFilters);
    customerSelect.addEventListener("change", updateMachineDropdown);
  </script>
</body>
</html>
